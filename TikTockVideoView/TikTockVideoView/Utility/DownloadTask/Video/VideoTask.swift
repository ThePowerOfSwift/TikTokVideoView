//
//  VideoTask.swift
//  TikTockVideoView
//
//  Created by Dinesh on 2/22/20.
//  Copyright Â© 2020 DINESH GUPTHA. All rights reserved.
//

import Foundation
import UIKit


public enum DownloadResult<T> {
    case success(T)
    case failure(String)
}

class VideoTask {

    static let shared = VideoTask()

    private let fileManager = FileManager.default

    private lazy var mainDirectoryUrl: URL = {

        let documentsUrl = self.fileManager.urls(for: .cachesDirectory, in: .userDomainMask).first!
        return documentsUrl
    }()

    func getFileWith(stringUrl: String, completionHandler: @escaping (DownloadResult<(URL)>) -> Void ) {


        let file = directoryFor(stringUrl: stringUrl)

        //return file path if already exists in cache directory
        guard !fileManager.fileExists(atPath: file.path)  else {
            completionHandler(DownloadResult.success(file))
            return
        }

        DispatchQueue.global().async {

            if let videoData = NSData(contentsOf: URL(string: stringUrl)!) {
                videoData.write(to: file, atomically: true)

                DispatchQueue.main.async {
                    completionHandler(DownloadResult.success(file))
                }
            } else {
                DispatchQueue.main.async {
                    completionHandler(DownloadResult.failure("Failed to download"))
                }
            }
        }
    }

    private func directoryFor(stringUrl: String) -> URL {

        let fileURL = URL(string: stringUrl)!.lastPathComponent

        let file = self.mainDirectoryUrl.appendingPathComponent(fileURL)

        return file
    }
}
